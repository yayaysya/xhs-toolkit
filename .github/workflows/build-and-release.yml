name: ðŸš€ æž„å»ºå’Œå‘å¸ƒå°çº¢ä¹¦MCPå·¥å…·åŒ…

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
    branches:
      - main  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è¿›è¡Œæž„å»ºæµ‹è¯•
  pull_request:
    branches: [ main ]

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  lint-and-test:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest
        
    - name: ðŸ” ä»£ç é£Žæ ¼æ£€æŸ¥
      run: |
        # è·³è¿‡é•¿è¡Œå’Œä¸€äº›å¸¸è§è­¦å‘Š
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: âœ… è¯­æ³•æ£€æŸ¥
      run: |
        python -m py_compile xhs_mcp_server.py
        python -m py_compile xhs_toolkit.py  
        python -m py_compile cookie_helper.py

  # ============================================
  # å¤šå¹³å°æž„å»º
  # ============================================
  build:
    name: ðŸ”¨ æž„å»º ${{ matrix.os }}
    needs: lint-and-test
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            binary_name: xhs-toolkit-linux-x64
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y wget unzip xvfb
              
          - os: windows-latest  
            platform: windows
            arch: x64
            binary_name: xhs-toolkit-windows-x64.exe
            setup_cmd: |
              # Windowså¹³å°æš‚ä¸å®‰è£…Chromeï¼ˆç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼‰
              echo "Windows platform setup"
              
          - os: macos-latest
            platform: macos
            arch: x64  
            binary_name: xhs-toolkit-macos-x64
            setup_cmd: |
              # macOSå¹³å°æš‚ä¸å®‰è£…Chromeï¼ˆç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼‰
              echo "macOS platform setup"
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ  
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ”§ å¹³å°ç‰¹å®šè®¾ç½®
      run: ${{ matrix.setup_cmd }}
      shell: bash
      
    - name: ðŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ðŸ”¨ æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        pyinstaller \
          --onefile \
          --name ${{ matrix.binary_name }} \
          --add-data "env_example.txt:." \
          --hidden-import dotenv \
          --hidden-import selenium \
          --hidden-import selenium.webdriver \
          --hidden-import selenium.webdriver.chrome.service \
          --hidden-import fastmcp \
          --hidden-import loguru \
          --hidden-import pydantic \
          --console \
          xhs_toolkit.py
      shell: bash
      
    - name: ðŸ” æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        echo "ðŸ“ æž„å»ºç›®å½•ç»“æž„:"
        find dist/ -type f
        echo "ðŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯:"
        ls -la dist/
      shell: bash
      
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary_name }}
        path: |
          dist/${{ matrix.binary_name }}*
          env_example.txt
          README.md
          LICENSE
        retention-days: 7

  # ============================================
  # åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  # ============================================
  release:
    name: ðŸŽ‰ åˆ›å»ºRelease
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # åªåœ¨ç‰ˆæœ¬æ ‡ç­¾æ—¶åˆ›å»ºrelease
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: ðŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release/
        
        # æ£€æŸ¥ä¸‹è½½çš„artifactç»“æž„
        echo "ðŸ“‹ Artifactç»“æž„æ£€æŸ¥:"
        find artifacts/ -type f | head -20
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºåŽ‹ç¼©åŒ…
        cd artifacts/
        
        # Linux
        if [ -d "xhs-toolkit-linux-x64" ]; then
          mkdir -p linux-package
          # æŸ¥æ‰¾Linuxå¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-linux-x64/dist/xhs-toolkit-linux-x64" ]; then
            cp xhs-toolkit-linux-x64/dist/xhs-toolkit-linux-x64 linux-package/xhs-toolkit
          elif [ -f "xhs-toolkit-linux-x64/xhs-toolkit-linux-x64" ]; then
            cp xhs-toolkit-linux-x64/xhs-toolkit-linux-x64 linux-package/xhs-toolkit
          else
            echo "âŒ Linuxå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-linux-x64/ -name "*linux*" -type f
          fi
          cp xhs-toolkit-linux-x64/{env_example.txt,README.md,LICENSE} linux-package/ 2>/dev/null || true
          tar -czf ../release/xhs-toolkit-linux-x64.tar.gz -C linux-package .
        fi
        
        # Windows  
        if [ -d "xhs-toolkit-windows-x64.exe" ]; then
          mkdir -p windows-package
          # æŸ¥æ‰¾Windowså¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-windows-x64.exe/dist/xhs-toolkit-windows-x64.exe" ]; then
            cp xhs-toolkit-windows-x64.exe/dist/xhs-toolkit-windows-x64.exe windows-package/xhs-toolkit.exe
          elif [ -f "xhs-toolkit-windows-x64.exe/xhs-toolkit-windows-x64.exe" ]; then
            cp xhs-toolkit-windows-x64.exe/xhs-toolkit-windows-x64.exe windows-package/xhs-toolkit.exe
          else
            echo "âŒ Windowså¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-windows-x64.exe/ -name "*windows*" -type f
          fi
          cp xhs-toolkit-windows-x64.exe/{env_example.txt,README.md,LICENSE} windows-package/ 2>/dev/null || true
          cd windows-package && zip -r ../../release/xhs-toolkit-windows-x64.zip . && cd ..
        fi
        
        # macOS
        if [ -d "xhs-toolkit-macos-x64" ]; then
          mkdir -p macos-package  
          # æŸ¥æ‰¾macOSå¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-macos-x64/dist/xhs-toolkit-macos-x64" ]; then
            cp xhs-toolkit-macos-x64/dist/xhs-toolkit-macos-x64 macos-package/xhs-toolkit
          elif [ -f "xhs-toolkit-macos-x64/xhs-toolkit-macos-x64" ]; then
            cp xhs-toolkit-macos-x64/xhs-toolkit-macos-x64 macos-package/xhs-toolkit
          else
            echo "âŒ macOSå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-macos-x64/ -name "*macos*" -type f
          fi
          cp xhs-toolkit-macos-x64/{env_example.txt,README.md,LICENSE} macos-package/ 2>/dev/null || true
          tar -czf ../release/xhs-toolkit-macos-x64.tar.gz -C macos-package .
        fi
        
        cd ../
        echo "ðŸ“¦ æœ€ç»ˆå‘å¸ƒæ–‡ä»¶:"
        ls -la release/
        
    - name: ðŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > release-notes.md << 'EOF'
        ## ðŸŒº å°çº¢ä¹¦MCPå·¥å…·åŒ… ${{ github.ref_name }}
        
        ### âœ¨ æ–°ç‰¹æ€§
        - æ”¯æŒå°çº¢ä¹¦å›¾æ–‡ç¬”è®°è‡ªåŠ¨å‘å¸ƒ
        - å®Œæ•´çš„MCPåè®®æ”¯æŒï¼Œä¸ŽClaude Desktopæ— ç¼é›†æˆ
        - æ™ºèƒ½Cookieç®¡ç†å’ŒéªŒè¯
        - å¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶æ”¯æŒ
        
        ### ðŸ“‹ åŠŸèƒ½æ¸…å•
        - [x] **å›¾æ–‡å‘å¸ƒ** - æ”¯æŒå‘å¸ƒæ–‡å­—å’Œå›¾ç‰‡ç¬”è®°
        - [x] **Cookieç®¡ç†** - å®‰å…¨èŽ·å–ã€éªŒè¯å’Œç®¡ç†ç™»å½•å‡­è¯
        - [x] **MCPåè®®æ”¯æŒ** - ä¸ŽAIå®¢æˆ·ç«¯å®Œç¾Žé›†æˆ
        - [x] **å†…å®¹æœç´¢** - æ‰¹é‡æœç´¢å’Œåˆ†æžç¬”è®°
        - [x] **ç”¨æˆ·ä¿¡æ¯** - èŽ·å–ç”¨æˆ·æ¡£æ¡ˆå’Œæ•°æ®åˆ†æž
        - [ ] **è§†é¢‘å‘å¸ƒ** - æ”¯æŒå‘å¸ƒè§†é¢‘ç¬”è®°ï¼ˆå¼€å‘ä¸­ï¼‰
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        
        1. **ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶**
        2. **è§£åŽ‹åˆ°ä»»æ„ç›®å½•**
        3. **å¤åˆ¶é…ç½®æ–‡ä»¶**: `cp env_example.txt .env`
        4. **ç¼–è¾‘é…ç½®**: å¡«å…¥Chromeè·¯å¾„ã€ChromeDriverè·¯å¾„å’Œæ‰‹æœºå·
        5. **èŽ·å–ç™»å½•å‡­è¯**: `./xhs-toolkit cookie save`
        6. **å¯åŠ¨MCPæœåŠ¡**: `./xhs-toolkit server start`
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        | å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |
        |------|------|------|
        | ðŸ§ Linux | `xhs-toolkit-linux-x64.tar.gz` | é€‚ç”¨äºŽx64 Linuxç³»ç»Ÿ |
        | ðŸªŸ Windows | `xhs-toolkit-windows-x64.zip` | é€‚ç”¨äºŽx64 Windowsç³»ç»Ÿ |
        | ðŸŽ macOS | `xhs-toolkit-macos-x64.tar.gz` | é€‚ç”¨äºŽIntel Mac |
        
        ### âš ï¸ ä½¿ç”¨è¦æ±‚
        
        - **Chromeæµè§ˆå™¨**: å¿…é¡»å®‰è£…Google Chrome
        - **ChromeDriver**: éœ€è¦å®‰è£…åŒ¹é…ç‰ˆæœ¬çš„ChromeDriver
        - **ç½‘ç»œè¿žæŽ¥**: éœ€è¦èƒ½å¤Ÿè®¿é—®å°çº¢ä¹¦ç½‘ç«™
        - **é…ç½®æ–‡ä»¶**: å¿…é¡»æ­£ç¡®é…ç½®.envæ–‡ä»¶
        
        ### ðŸ”— ç›¸å…³é“¾æŽ¥
        
        - [ðŸ“– å®Œæ•´æ–‡æ¡£](https://github.com/aki66938/xiaohongshu-mcp-toolkit/blob/main/README.md)
        - [ðŸ› é—®é¢˜åé¦ˆ](https://github.com/aki66938/xiaohongshu-mcp-toolkit/issues)
        - [ðŸ’¬ è®¨è®ºäº¤æµ](https://github.com/aki66938/xiaohongshu-mcp-toolkit/discussions)
        
        ---
        
        **Made with â¤ï¸ for content creators**
        EOF
        
    - name: ðŸŽ‰ åˆ›å»ºGitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # æ£€æŸ¥GitHub CLIæ˜¯å¦å¯ç”¨
        gh --version
        
        # æ£€æŸ¥Tokenæƒé™
        echo "ðŸ”‘ æ£€æŸ¥GitHub Tokenæƒé™..."
        gh auth status
        
        # æ£€æŸ¥è¦ä¸Šä¼ çš„æ–‡ä»¶
        echo "ðŸ“¦ è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨:"
        find release/ -type f -exec ls -la {} \;
        
        # åˆ›å»ºRelease
        echo "ðŸš€ åˆ›å»ºGitHub Release..."
        gh release create "${{ github.ref_name }}" \
          --title "å°çº¢ä¹¦MCPå·¥å…·åŒ… ${{ github.ref_name }}" \
          --notes-file release-notes.md \
          --draft=false \
          --prerelease=false \
          release/*
        
    - name: ðŸ“Š å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Release ${{ github.ref_name }} åˆ›å»ºæˆåŠŸ!"
        echo "ðŸ“¦ åŒ…å«ä»¥ä¸‹æ–‡ä»¶:"
        ls -la release/
        echo "ðŸ”— è®¿é—®åœ°å€: https://github.com/aki66938/xhs-toolkit/releases/tag/${{ github.ref_name }}" 