name: ğŸš€ æ„å»ºå’Œå‘å¸ƒå°çº¢ä¹¦MCPå·¥å…·åŒ…

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      use_custom_notes:
        description: 'ä½¿ç”¨è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜'
        required: false
        default: false
        type: boolean
      additional_notes:
        description: 'é¢å¤–å‘å¸ƒè¯´æ˜ï¼ˆå¯é€‰ï¼Œå°†è¿½åŠ åˆ°RELEASE_NOTES.mdåï¼‰'
        required: false
        default: ''
        type: string
  
  # æ¨é€æ ‡ç­¾æ—¶ä¹Ÿè§¦å‘ï¼ˆå¤‡ç”¨æ–¹å¼ï¼‰
  push:
    tags:
      - 'v*'

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  lint-and-test:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest
        
    - name: ğŸ” ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        # è·³è¿‡é•¿è¡Œå’Œä¸€äº›å¸¸è§è­¦å‘Š
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
          --exclude=__pycache__,*.pyc,build,dist
        
    - name: âœ… è¯­æ³•æ£€æŸ¥
      run: |
        # æ£€æŸ¥ä¸»å…¥å£æ–‡ä»¶
        python -m py_compile xhs_toolkit.py
        
        # æ£€æŸ¥srcç›®å½•ä¸‹çš„æ‰€æœ‰Pythonæ–‡ä»¶
        find src/ -name "*.py" -type f | while read file; do
          echo "æ£€æŸ¥æ–‡ä»¶: $file"
          python -m py_compile "$file"
        done
        
    - name: ğŸ§ª æ¨¡å—å¯¼å…¥æµ‹è¯•
      run: |
        # æµ‹è¯•å…³é”®æ¨¡å—å¯¼å…¥
        python -c "
        import sys
        sys.path.insert(0, '.')
        
        # æµ‹è¯•æ ¸å¿ƒæ¨¡å—
        from src.core.config import XHSConfig
        from src.core.exceptions import XHSToolkitError
        from src.core.browser import ChromeDriverManager
        
        # æµ‹è¯•è®¤è¯æ¨¡å—
        from src.auth.cookie_manager import CookieManager
        
        # æµ‹è¯•å·¥å…·æ¨¡å—
        from src.utils.logger import get_logger
        from src.utils.text_utils import safe_print
        
        # æµ‹è¯•å°çº¢ä¹¦æ¨¡å—
        from src.xiaohongshu.models import XHSNote
        from src.xiaohongshu.client import XHSClient
        
        # æµ‹è¯•æœåŠ¡å™¨æ¨¡å—
        from src.server.mcp_server import MCPServer
        
        print('âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ')
        "

  # ============================================
  # å¤šå¹³å°æ„å»º
  # ============================================
  build:
    name: ğŸ”¨ æ„å»º ${{ matrix.os }}
    needs: lint-and-test
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            binary_name: xhs-toolkit-linux-x64
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y wget unzip xvfb
              
          - os: windows-latest  
            platform: windows
            arch: x64
            binary_name: xhs-toolkit-windows-x64.exe
            setup_cmd: |
              # Windowså¹³å°æš‚ä¸å®‰è£…Chromeï¼ˆç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼‰
              echo "Windows platform setup"
              
          - os: macos-latest
            platform: macos
            arch: x64  
            binary_name: xhs-toolkit-macos-x64
            setup_cmd: |
              # macOSå¹³å°æš‚ä¸å®‰è£…Chromeï¼ˆç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼‰
              echo "macOS platform setup"
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ  
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ”§ å¹³å°ç‰¹å®šè®¾ç½®
      run: ${{ matrix.setup_cmd }}
      shell: bash
      
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ğŸ”¨ æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        # ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼Œä½¿ç”¨specæ–‡ä»¶æ„å»º
        pwd
        ls -la
        echo "æ„å»ºå‰æ£€æŸ¥æ–‡ä»¶ï¼š"
        ls -la xhs_toolkit.py
        ls -la .github/xhs_toolkit.spec
        
        # ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡ŒPyInstaller
        python -m PyInstaller \
          --clean \
          --noconfirm \
          --workpath ./build \
          --distpath ./dist \
          .github/xhs_toolkit.spec
        
        # é‡å‘½åç”Ÿæˆçš„æ–‡ä»¶ä»¥åŒ¹é…å¹³å°
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Windowså¹³å°åº”è¯¥ç”Ÿæˆ.exeæ–‡ä»¶
          if [ -f "dist/xhs-toolkit.exe" ]; then
            mv dist/xhs-toolkit.exe dist/${{ matrix.binary_name }}
          elif [ -f "dist/xhs-toolkit" ]; then
            mv dist/xhs-toolkit dist/${{ matrix.binary_name }}
          fi
        else
          # Linuxå’ŒmacOSå¹³å°
          if [ -f "dist/xhs-toolkit" ]; then
            mv dist/xhs-toolkit dist/${{ matrix.binary_name }}
          elif [ -f "dist/xhs-toolkit.exe" ]; then
            mv dist/xhs-toolkit.exe dist/${{ matrix.binary_name }}
          fi
        fi
      shell: bash
      
    - name: ğŸ” æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "ğŸ“ æ„å»ºç›®å½•ç»“æ„:"
        find dist/ -type f
        echo "ğŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯:"
        ls -la dist/
      shell: bash
      
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary_name }}
        path: |
          dist/${{ matrix.binary_name }}*
          env_example
          README.md
          LICENSE
        retention-days: 7

  # ============================================
  # åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  # ============================================
  release:
    name: ğŸ‰ åˆ›å»ºRelease
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆæ›´æ–°æ—¥å¿—
    
    - name: ğŸ·ï¸ è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        # ä»version.txtè¯»å–ç‰ˆæœ¬å·
        if [ -f "version.txt" ]; then
          VERSION_NO_V=$(cat version.txt | tr -d '\n\r' | xargs)
          echo "ğŸ“„ ä»version.txtè¯»å–ç‰ˆæœ¬: $VERSION_NO_V"
        else
          echo "âŒ version.txtæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ç¡®ä¿ç‰ˆæœ¬å·ä»¥vå¼€å¤´
        if [[ $VERSION_NO_V == v* ]]; then
          VERSION=$VERSION_NO_V
          VERSION_NO_V=${VERSION#v}
        else
          VERSION="v$VERSION_NO_V"
        fi
        
        echo "ğŸ·ï¸ æœ€ç»ˆç‰ˆæœ¬å·: $VERSION"
        echo "ğŸ“ ç‰ˆæœ¬å·ï¼ˆæ— vï¼‰: $VERSION_NO_V"
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_no_v=${VERSION_NO_V}" >> $GITHUB_OUTPUT
      
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: ğŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release/
        
        # æ£€æŸ¥ä¸‹è½½çš„artifactç»“æ„
        echo "ğŸ“‹ Artifactç»“æ„æ£€æŸ¥:"
        find artifacts/ -type f | head -20
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºå‹ç¼©åŒ…
        cd artifacts/
        
        # Linux
        if [ -d "xhs-toolkit-linux-x64" ]; then
          mkdir -p linux-package
          # æŸ¥æ‰¾Linuxå¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-linux-x64/dist/xhs-toolkit-linux-x64" ]; then
            cp xhs-toolkit-linux-x64/dist/xhs-toolkit-linux-x64 linux-package/xhs-toolkit
          elif [ -f "xhs-toolkit-linux-x64/xhs-toolkit-linux-x64" ]; then
            cp xhs-toolkit-linux-x64/xhs-toolkit-linux-x64 linux-package/xhs-toolkit
          else
            echo "âŒ Linuxå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-linux-x64/ -name "*linux*" -type f
          fi
          cp xhs-toolkit-linux-x64/{env_example,README.md,LICENSE} linux-package/ 2>/dev/null || true
          tar -czf ../release/xhs-toolkit-linux-x64.tar.gz -C linux-package .
        fi
        
        # Windows  
        if [ -d "xhs-toolkit-windows-x64.exe" ]; then
          mkdir -p windows-package
          # æŸ¥æ‰¾Windowså¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-windows-x64.exe/dist/xhs-toolkit-windows-x64.exe" ]; then
            cp xhs-toolkit-windows-x64.exe/dist/xhs-toolkit-windows-x64.exe windows-package/xhs-toolkit.exe
          elif [ -f "xhs-toolkit-windows-x64.exe/xhs-toolkit-windows-x64.exe" ]; then
            cp xhs-toolkit-windows-x64.exe/xhs-toolkit-windows-x64.exe windows-package/xhs-toolkit.exe
          else
            echo "âŒ Windowså¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-windows-x64.exe/ -name "*windows*" -type f
          fi
          cp xhs-toolkit-windows-x64.exe/{env_example,README.md,LICENSE} windows-package/ 2>/dev/null || true
          cd windows-package && zip -r ../../release/xhs-toolkit-windows-x64.zip . && cd ..
        fi
        
        # macOS
        if [ -d "xhs-toolkit-macos-x64" ]; then
          mkdir -p macos-package  
          # æŸ¥æ‰¾macOSå¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-macos-x64/dist/xhs-toolkit-macos-x64" ]; then
            cp xhs-toolkit-macos-x64/dist/xhs-toolkit-macos-x64 macos-package/xhs-toolkit
          elif [ -f "xhs-toolkit-macos-x64/xhs-toolkit-macos-x64" ]; then
            cp xhs-toolkit-macos-x64/xhs-toolkit-macos-x64 macos-package/xhs-toolkit
          else
            echo "âŒ macOSå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-macos-x64/ -name "*macos*" -type f
          fi
          cp xhs-toolkit-macos-x64/{env_example,README.md,LICENSE} macos-package/ 2>/dev/null || true
          tar -czf ../release/xhs-toolkit-macos-x64.tar.gz -C macos-package .
        fi
        
        cd ../
        echo "ğŸ“¦ æœ€ç»ˆå‘å¸ƒæ–‡ä»¶:"
        ls -la release/
        
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        echo "ğŸ“ å‡†å¤‡å‘å¸ƒè¯´æ˜..."
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨.github/workflows/RELEASE_NOTES.md
        if [ -f ".github/workflows/RELEASE_NOTES.md" ]; then
          echo "ğŸ“„ ä½¿ç”¨.github/workflows/RELEASE_NOTES.mdä½œä¸ºå‘å¸ƒè¯´æ˜"
          cp .github/workflows/RELEASE_NOTES.md release-notes.md
        else
          echo "ğŸ“ æœªæ‰¾åˆ°å‘å¸ƒè¯´æ˜æ–‡ä»¶ï¼Œä½¿ç”¨ç‰ˆæœ¬å·ä½œä¸ºå‘å¸ƒè¯´æ˜"
          echo "## å°çº¢ä¹¦MCPå·¥å…·åŒ… ${VERSION}" > release-notes.md
        fi
        
        # å¦‚æœæ‰‹åŠ¨è¾“å…¥äº†é¢å¤–çš„å‘å¸ƒè¯´æ˜ï¼Œè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
        if [ -n "${{ github.event.inputs.additional_notes }}" ]; then
          echo "" >> release-notes.md
          echo "### é¢å¤–è¯´æ˜" >> release-notes.md
          echo "" >> release-notes.md
          echo "${{ github.event.inputs.additional_notes }}" >> release-notes.md
        fi
        
        echo "âœ… å‘å¸ƒè¯´æ˜å‡†å¤‡å®Œæˆ"
        
    - name: ğŸ‰ åˆ›å»ºGitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.version.outputs.version }}
        name: "å°çº¢ä¹¦MCPå·¥å…·åŒ… ${{ steps.version.outputs.version }}"
        bodyFile: release-notes.md
        draft: false
        prerelease: false
        artifacts: "release/*"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true  # å…è®¸æ›´æ–°å·²å­˜åœ¨çš„release
        makeLatest: true    # æ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬
        generateReleaseNotes: false  # ä¸ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆï¼Œä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰è¯´æ˜
        
    - name: ğŸ“Š å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ Release ${{ steps.version.outputs.version }} åˆ›å»ºæˆåŠŸ!"
        echo "ğŸ“¦ åŒ…å«ä»¥ä¸‹æ–‡ä»¶:"
        ls -la release/
        echo "ğŸ”— è®¿é—®åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" 