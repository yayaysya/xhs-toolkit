name: ğŸš€ æ„å»ºå’Œå‘å¸ƒå°çº¢ä¹¦MCPå·¥å…·åŒ…

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      version:
        description: 'xhs_toolkit:v1.0.1'
        required: true
        default: 'v1.0.1'
        type: string
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch   # ä¿®å¤ç‰ˆæœ¬ (1.0.0 -> 1.0.1)
        - minor   # åŠŸèƒ½ç‰ˆæœ¬ (1.0.0 -> 1.1.0)
        - major   # é‡å¤§ç‰ˆæœ¬ (1.0.0 -> 2.0.0)
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜ï¼ˆå¯é€‰ï¼Œå°†è¿½åŠ åˆ°è‡ªåŠ¨ç”Ÿæˆçš„è¯´æ˜åï¼‰'
        required: false
        default: ''
        type: string
  
  # æ¨é€æ ‡ç­¾æ—¶ä¹Ÿè§¦å‘ï¼ˆå¤‡ç”¨æ–¹å¼ï¼‰
  push:
    tags:
      - 'v*'

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  lint-and-test:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest
        
    - name: ğŸ” ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        # è·³è¿‡é•¿è¡Œå’Œä¸€äº›å¸¸è§è­¦å‘Š
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: âœ… è¯­æ³•æ£€æŸ¥
      run: |
        python -m py_compile xhs_mcp_server.py
        python -m py_compile xhs_toolkit.py  
        python -m py_compile cookie_helper.py

  # ============================================
  # å¤šå¹³å°æ„å»º
  # ============================================
  build:
    name: ğŸ”¨ æ„å»º ${{ matrix.os }}
    needs: lint-and-test
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            binary_name: xhs-toolkit-linux-x64
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y wget unzip xvfb
              
          - os: windows-latest  
            platform: windows
            arch: x64
            binary_name: xhs-toolkit-windows-x64.exe
            setup_cmd: |
              # Windowså¹³å°æš‚ä¸å®‰è£…Chromeï¼ˆç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼‰
              echo "Windows platform setup"
              
          - os: macos-latest
            platform: macos
            arch: x64  
            binary_name: xhs-toolkit-macos-x64
            setup_cmd: |
              # macOSå¹³å°æš‚ä¸å®‰è£…Chromeï¼ˆç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼‰
              echo "macOS platform setup"
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ  
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ”§ å¹³å°ç‰¹å®šè®¾ç½®
      run: ${{ matrix.setup_cmd }}
      shell: bash
      
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ğŸ”¨ æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        pyinstaller \
          --onefile \
          --name ${{ matrix.binary_name }} \
          --add-data "env_example:." \
          --hidden-import dotenv \
          --hidden-import selenium \
          --hidden-import selenium.webdriver \
          --hidden-import selenium.webdriver.chrome.service \
          --hidden-import fastmcp \
          --hidden-import loguru \
          --hidden-import pydantic \
          --console \
          xhs_toolkit.py
      shell: bash
      
    - name: ğŸ” æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "ğŸ“ æ„å»ºç›®å½•ç»“æ„:"
        find dist/ -type f
        echo "ğŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯:"
        ls -la dist/
      shell: bash
      
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary_name }}
        path: |
          dist/${{ matrix.binary_name }}*
          env_example
          README.md
          LICENSE
        retention-days: 7

  # ============================================
  # åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  # ============================================
  release:
    name: ğŸ‰ åˆ›å»ºRelease
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆæ›´æ–°æ—¥å¿—
    
    - name: ğŸ·ï¸ è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        else
          VERSION="${{ github.ref_name }}"
          RELEASE_TYPE="patch"
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT
        echo "version_no_v=${VERSION#v}" >> $GITHUB_OUTPUT
      
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: ğŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release/
        
        # æ£€æŸ¥ä¸‹è½½çš„artifactç»“æ„
        echo "ğŸ“‹ Artifactç»“æ„æ£€æŸ¥:"
        find artifacts/ -type f | head -20
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºå‹ç¼©åŒ…
        cd artifacts/
        
        # Linux
        if [ -d "xhs-toolkit-linux-x64" ]; then
          mkdir -p linux-package
          # æŸ¥æ‰¾Linuxå¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-linux-x64/dist/xhs-toolkit-linux-x64" ]; then
            cp xhs-toolkit-linux-x64/dist/xhs-toolkit-linux-x64 linux-package/xhs-toolkit
          elif [ -f "xhs-toolkit-linux-x64/xhs-toolkit-linux-x64" ]; then
            cp xhs-toolkit-linux-x64/xhs-toolkit-linux-x64 linux-package/xhs-toolkit
          else
            echo "âŒ Linuxå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-linux-x64/ -name "*linux*" -type f
          fi
          cp xhs-toolkit-linux-x64/{env_example,README.md,LICENSE} linux-package/ 2>/dev/null || true
          tar -czf ../release/xhs-toolkit-linux-x64.tar.gz -C linux-package .
        fi
        
        # Windows  
        if [ -d "xhs-toolkit-windows-x64.exe" ]; then
          mkdir -p windows-package
          # æŸ¥æ‰¾Windowså¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-windows-x64.exe/dist/xhs-toolkit-windows-x64.exe" ]; then
            cp xhs-toolkit-windows-x64.exe/dist/xhs-toolkit-windows-x64.exe windows-package/xhs-toolkit.exe
          elif [ -f "xhs-toolkit-windows-x64.exe/xhs-toolkit-windows-x64.exe" ]; then
            cp xhs-toolkit-windows-x64.exe/xhs-toolkit-windows-x64.exe windows-package/xhs-toolkit.exe
          else
            echo "âŒ Windowså¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-windows-x64.exe/ -name "*windows*" -type f
          fi
          cp xhs-toolkit-windows-x64.exe/{env_example,README.md,LICENSE} windows-package/ 2>/dev/null || true
          cd windows-package && zip -r ../../release/xhs-toolkit-windows-x64.zip . && cd ..
        fi
        
        # macOS
        if [ -d "xhs-toolkit-macos-x64" ]; then
          mkdir -p macos-package  
          # æŸ¥æ‰¾macOSå¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "xhs-toolkit-macos-x64/dist/xhs-toolkit-macos-x64" ]; then
            cp xhs-toolkit-macos-x64/dist/xhs-toolkit-macos-x64 macos-package/xhs-toolkit
          elif [ -f "xhs-toolkit-macos-x64/xhs-toolkit-macos-x64" ]; then
            cp xhs-toolkit-macos-x64/xhs-toolkit-macos-x64 macos-package/xhs-toolkit
          else
            echo "âŒ macOSå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            find xhs-toolkit-macos-x64/ -name "*macos*" -type f
          fi
          cp xhs-toolkit-macos-x64/{env_example,README.md,LICENSE} macos-package/ 2>/dev/null || true
          tar -czf ../release/xhs-toolkit-macos-x64.tar.gz -C macos-package .
        fi
        
        cd ../
        echo "ğŸ“¦ æœ€ç»ˆå‘å¸ƒæ–‡ä»¶:"
        ls -la release/
        
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        RELEASE_TYPE="${{ steps.version.outputs.release_type }}"
        VERSION_NO_V="${{ steps.version.outputs.version_no_v }}"
        
        # æ ¹æ®ç‰ˆæœ¬ç”Ÿæˆç‰¹å®šçš„æ›´æ–°è¯´æ˜
        if [ "${VERSION_NO_V}" = "1.0.1" ]; then
          cat > release-notes.md << 'EOF'
        ## ğŸŒº å°çº¢ä¹¦MCPå·¥å…·åŒ… v1.0.1
        
        > ğŸ”§ **ä¿®å¤ç‰ˆæœ¬** - è§£å†³Cookieå¤±æ•ˆå’Œé…ç½®é—®é¢˜
        
        ### ğŸ› Bugä¿®å¤
        
        - **ğŸª ä¿®å¤Cookieå¤±æ•ˆé—®é¢˜**: é‡æ–°å®šä½å¯¼èˆªé¡µé¢ä¸ºåˆ›ä½œè€…ä¸­å¿ƒï¼Œè§£å†³è·³è½¬æ—¶Cookieå¤±æ•ˆçš„é—®é¢˜
        - **ğŸŒ ä¿®å¤åŸŸåä¸åŒ¹é…**: å°†é»˜è®¤åŸŸåä» `www.xiaohongshu.com` æ”¹ä¸º `creator.xiaohongshu.com`
        - **ğŸ”§ ä¿®å¤å¤šå¹³å°ç¯å¢ƒå˜é‡é…ç½®**: è§£å†³Windows/Mac/Linuxå¹³å°ä¸‹è·¯å¾„é…ç½®é—®é¢˜
        - **ğŸ“± ç§»é™¤æ‰‹æœºå·éªŒè¯**: ç®€åŒ–ç™»å½•æµç¨‹ï¼Œå®Œå…¨ä¾èµ–Cookieè®¤è¯ï¼Œä¸å†éœ€è¦æ‰‹æœºå·é…ç½®
        
        ### âœ¨ æ”¹è¿›ä¼˜åŒ–
        
        - **ğŸ¯ ç›´æ¥è®¿é—®åˆ›ä½œè€…ä¸­å¿ƒ**: ç™»å½•æ—¶ç›´æ¥æ‰“å¼€åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢ï¼Œç¡®ä¿è·å–å®Œæ•´æƒé™
        - **ğŸ” æ™ºèƒ½è·¯å¾„æ£€æµ‹**: Chromeå’ŒChromeDriveræ”¯æŒè‡ªåŠ¨æ£€æµ‹ï¼Œå‡å°‘é…ç½®å¤æ‚åº¦
        - **ğŸ“ æ›´æ–°é…ç½®æ¨¡æ¿**: ç®€åŒ– `env_example` æ–‡ä»¶ï¼Œç§»é™¤ä¸å¿…è¦çš„é…ç½®é¡¹
        - **ğŸ—ï¸ æ”¹è¿›Cookieæ ¼å¼**: æ”¯æŒæ–°ç‰ˆCookieæ ¼å¼ï¼ŒåŒ…å«ç‰ˆæœ¬å’ŒåŸŸåä¿¡æ¯ï¼Œå‘ä¸‹å…¼å®¹æ—§æ ¼å¼
        
        ### ğŸ› ï¸ æŠ€æœ¯æ”¹è¿›
        
        - è·¨å¹³å°Chromeè·¯å¾„è‡ªåŠ¨æ£€æµ‹
        - ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é…ç½®ç³»ç»Ÿ
        - å¢å¼ºçš„CookieéªŒè¯å’Œé”™è¯¯å¤„ç†
        - ç»Ÿä¸€çš„é”™è¯¯æç¤ºå’Œå¸®åŠ©ä¿¡æ¯
        
        
        ### ğŸš€ å¿«é€Ÿå¼€å§‹
        
        1. **ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶**
        2. **è§£å‹åˆ°ä»»æ„ç›®å½•**  
        3. **å¤åˆ¶é…ç½®æ–‡ä»¶**: `cp env_example .env`
        4. **ç¼–è¾‘é…ç½®**: å¡«å…¥Chromeå’ŒChromeDriverè·¯å¾„ï¼ˆå¯é€‰ï¼Œæ”¯æŒè‡ªåŠ¨æ£€æµ‹ï¼‰
        5. **è·å–ç™»å½•å‡­è¯**: `./xhs-toolkit cookie save`
        6. **å¯åŠ¨MCPæœåŠ¡**: `./xhs-toolkit server start`
        
        ### ğŸ“¦ ä¸‹è½½è¯´æ˜
        
        | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
        |------|------|------|
        | ğŸ§ Linux | `xhs-toolkit-linux-x64.tar.gz` | é€‚ç”¨äºx64 Linuxç³»ç»Ÿ |
        | ğŸªŸ Windows | `xhs-toolkit-windows-x64.zip` | é€‚ç”¨äºx64 Windowsç³»ç»Ÿ |
        | ğŸ macOS | `xhs-toolkit-macos-x64.tar.gz` | é€‚ç”¨äºIntel Mac |
        
        ### âš ï¸ é‡è¦å˜æ›´
        
        - **ä¸å†éœ€è¦æ‰‹æœºå·é…ç½®**: åˆ é™¤äº† `phone` é…ç½®é¡¹ï¼Œå®Œå…¨ä¾èµ–Cookieè®¤è¯
        - **é…ç½®æ›´ç®€å•**: Chromeå’ŒChromeDriveræ”¯æŒè‡ªåŠ¨æ£€æµ‹ï¼Œå‡å°‘æ‰‹åŠ¨é…ç½®
        - **CookieåŸŸåå˜æ›´**: ç°åœ¨ç›´æ¥è·å–åˆ›ä½œè€…ä¸­å¿ƒCookieï¼Œè§£å†³æƒé™é—®é¢˜
        
        ### ğŸ’¡ ä½¿ç”¨è¦æ±‚
        
        - **Chromeæµè§ˆå™¨**: å¿…é¡»å®‰è£…Google Chrome
        - **ChromeDriver**: éœ€è¦å®‰è£…åŒ¹é…ç‰ˆæœ¬çš„ChromeDriver
        - **ç½‘ç»œè¿æ¥**: éœ€è¦èƒ½å¤Ÿè®¿é—®å°çº¢ä¹¦ç½‘ç«™
        
        ### ğŸ”— ç›¸å…³é“¾æ¥
        
        - [ğŸ“– å®Œæ•´æ–‡æ¡£](https://github.com/aki66938/xiaohongshu-mcp-toolkit/blob/main/README.md)
        - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/aki66938/xiaohongshu-mcp-toolkit/issues)
        - [ğŸ’¬ è®¨è®ºäº¤æµ](https://github.com/aki66938/xiaohongshu-mcp-toolkit/discussions)
        
        ---
        
        **Made with â¤ï¸ for content creators**
        EOF
        else
          # é€šç”¨çš„å‘å¸ƒè¯´æ˜æ¨¡æ¿
          cat > release-notes.md << EOF
        ## ğŸŒº å°çº¢ä¹¦MCPå·¥å…·åŒ… ${VERSION}
        
        > ğŸ“¦ **${RELEASE_TYPE} ç‰ˆæœ¬å‘å¸ƒ**
        
        ### âœ¨ ä¸»è¦ç‰¹æ€§
        - æ”¯æŒå°çº¢ä¹¦å›¾æ–‡ç¬”è®°è‡ªåŠ¨å‘å¸ƒ
        - å®Œæ•´çš„MCPåè®®æ”¯æŒï¼Œä¸Claude Desktopæ— ç¼é›†æˆ
        - æ™ºèƒ½Cookieç®¡ç†å’ŒéªŒè¯
        - å¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶æ”¯æŒ
        
        ### ğŸ“‹ åŠŸèƒ½æ¸…å•
        - [x] **å›¾æ–‡å‘å¸ƒ** - æ”¯æŒå‘å¸ƒæ–‡å­—å’Œå›¾ç‰‡ç¬”è®°
        - [x] **Cookieç®¡ç†** - å®‰å…¨è·å–ã€éªŒè¯å’Œç®¡ç†ç™»å½•å‡­è¯
        - [x] **MCPåè®®æ”¯æŒ** - ä¸AIå®¢æˆ·ç«¯å®Œç¾é›†æˆ
        - [x] **ç”¨æˆ·ä¿¡æ¯** - è·å–ç”¨æˆ·æ¡£æ¡ˆå’Œæ•°æ®åˆ†æ
        - [ ] **è§†é¢‘å‘å¸ƒ** - æ”¯æŒå‘å¸ƒè§†é¢‘ç¬”è®°ï¼ˆå¼€å‘ä¸­ï¼‰
        
        ### ğŸš€ å¿«é€Ÿå¼€å§‹
        
        1. **ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶**
        2. **è§£å‹åˆ°ä»»æ„ç›®å½•**
                 3. **å¤åˆ¶é…ç½®æ–‡ä»¶**: \`cp env_example .env\`
        4. **ç¼–è¾‘é…ç½®**: å¡«å…¥Chromeå’ŒChromeDriverè·¯å¾„
        5. **è·å–ç™»å½•å‡­è¯**: \`./xhs-toolkit cookie save\`
        6. **å¯åŠ¨MCPæœåŠ¡**: \`./xhs-toolkit server start\`
        
        ### ğŸ“¦ ä¸‹è½½è¯´æ˜
        
        | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
        |------|------|------|
        | ğŸ§ Linux | \`xhs-toolkit-linux-x64.tar.gz\` | é€‚ç”¨äºx64 Linuxç³»ç»Ÿ |
        | ğŸªŸ Windows | \`xhs-toolkit-windows-x64.zip\` | é€‚ç”¨äºx64 Windowsç³»ç»Ÿ |
        | ğŸ macOS | \`xhs-toolkit-macos-x64.tar.gz\` | é€‚ç”¨äºIntel Mac |
        
        ---
        
        **Made with â¤ï¸ for content creators**
        EOF
        fi
        
        # å¦‚æœæ‰‹åŠ¨è¾“å…¥äº†é¢å¤–çš„å‘å¸ƒè¯´æ˜ï¼Œè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
        if [ -n "${{ github.event.inputs.release_notes }}" ]; then
          echo "" >> release-notes.md
          echo "### ğŸ“ å…¶ä»–è¯´æ˜" >> release-notes.md
          echo "" >> release-notes.md
          echo "${{ github.event.inputs.release_notes }}" >> release-notes.md
        fi
        
    - name: ğŸ‰ åˆ›å»ºGitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.version.outputs.version }}
        name: "å°çº¢ä¹¦MCPå·¥å…·åŒ… ${{ steps.version.outputs.version }}"
        bodyFile: release-notes.md
        draft: false
        prerelease: false
        artifacts: "release/*"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true  # å…è®¸æ›´æ–°å·²å­˜åœ¨çš„release
        makeLatest: true    # æ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬
        generateReleaseNotes: false  # ä¸ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆï¼Œä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰è¯´æ˜
        
    - name: ğŸ“Š å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ Release ${{ steps.version.outputs.version }} åˆ›å»ºæˆåŠŸ!"
        echo "ğŸ“¦ åŒ…å«ä»¥ä¸‹æ–‡ä»¶:"
        ls -la release/
        echo "ğŸ”— è®¿é—®åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" 